<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TechUties VM - Service Hub</title>
<style>
  :root { --bg:#0b0f14; --fg:#e6eef7; --muted:#94a3b8; --accent:#00c896; --accent2:#ff6fb1; --card:#0f151d; }
  html,body { margin:0; padding:0; background:var(--bg); color:var(--fg); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
  .wrap { max-width: 1100px; margin: 0 auto; padding: 48px 24px; }
  .hero { background: linear-gradient(135deg, rgba(0,200,150,0.15), rgba(59,130,246,0.12)); border:1px solid #163042; border-radius:16px; padding:32px; }
  .hero-head { display:flex; align-items:center; justify-content:space-between; gap:12px }
  h1 { margin:0 0 8px; font-size:32px; letter-spacing:.3px }
  p.lead { margin:0; color:var(--muted); }
  .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:16px; margin-top:12px; }
  .card { background:var(--card); border:1px solid #1f2937; border-radius:12px; padding:18px; transition: transform .1s ease, border-color .2s ease; position:relative }
  .card:hover { transform: translateY(-1px); border-color: #374151; }
  .card a { color:var(--fg); text-decoration:none; display:block }
  .name { font-weight:600; margin-bottom:6px }
  .url { color:var(--muted); font-size:13px }
  .thanks { margin-top: 28px }
  .thanks h3 { margin:0 0 8px; font-size:16px; color:#b9c6d2 }
  .footer { margin-top:32px; color:var(--muted); font-size:14px }
  .links a { color: var(--accent); text-decoration: none; }
  .thanks a { color: var(--accent2); font-weight:600; text-decoration:none }
  .thanks a:hover { text-decoration: underline }
  .status { margin-top: 8px; font-size: 13px; color: var(--muted) }
  .badge { position:absolute; top:12px; right:12px; font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid #1f2937 }
  .ok { background:#0d1f17; color:#6fe0b8; border-color:#1b3a2d }
  .err { background:#281215; color:#ff9aa7; border-color:#4d2228 }
  .warn { background:#2a2314; color:#ffdd8b; border-color:#4b3d1c }
  code { background:#101822; padding:2px 6px; border-radius:6px; border:1px solid #1f2a37 }
  .upload { display:none }
  /* Dashboard cards */
  .kpis { display:grid; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); gap:12px; margin-top:16px }
  .kpi { background:var(--card); border:1px solid #1f2937; border-radius:10px; padding:14px }
  .table { width:100%; border-collapse: collapse; margin-top: 10px }
  .table th, .table td { border:1px solid #1f2937; padding:8px; text-align:left; font-size:13px }
  .table th { background:#0b1017; color:#b9c6d2 }
  .copy { cursor:pointer; padding:4px 8px; border:1px solid #1f2937; border-radius:6px; background:#0e1a26; color:#e6eef7 }
  .row-inline { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
  .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center }
  .row input[type="file"] { color:var(--muted) }
  .row input[type="text"] { background:#0b1017; color:var(--fg); border:1px solid #1f2937; border-radius:8px; padding:8px 10px; min-width:260px }
  .btn { background:#0e1a26; color:#e6eef7; border:1px solid #1f2937; border-radius:8px; padding:8px 12px; cursor:pointer }
  .btn:hover { border-color:#374151 }
  .btn-sm { padding:6px 8px; font-size:12px }
  .section-title { margin:18px 0 8px; color:#b9c6d2; font-size:14px; text-transform:uppercase; letter-spacing:.08em }
  .chips { display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 4px }
  .chip { background:#0b1017; border:1px solid #1f2937; color:#cbd5e1; border-radius:999px; padding:6px 10px; font-size:12px }
  .chip .dot { width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:6px; position:relative; top:1px }
  .dot-ok { background:#00c896 }
  .dot-err { background:#ff6b6b }
  .vpn-head { display:flex; align-items:center; gap:12px; margin-bottom:8px }
  .muted { color:#9fb0c0; font-size:13px }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  
  /* Dashboard cards */
  .kpis { display:grid; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); gap:12px; margin-top:16px }
  .kpi { background:var(--card); border:1px solid #1f2937; border-radius:10px; padding:14px }
  
  /* Notification system */
  .notification { position: fixed; top: 20px; right: 20px; background: var(--card); border: 1px solid #1f2937; border-radius: 12px; padding: 16px; max-width: 300px; z-index: 1000; display: none; box-shadow: 0 10px 24px rgba(0,0,0,.25); }
  .notification.show { display: block; animation: slideIn 0.3s ease-out; }
  .notification-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
  .notification-icon { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; }
  .notification-icon.success { background: #0d1f17; color: #6fe0b8; }
  .notification-icon.error { background: #281215; color: #ff9aa7; }
  .notification-icon.info { background: #1a2332; color: #6bb6ff; }
  .notification-icon.update { background: #0d1f17; color: #6fe0b8; }
  .notification-icon.warning { background: #2a2314; color: #ffdd8b; }
  .notification-title { font-weight: 600; color: var(--fg); }
  .notification-message { color: var(--muted); font-size: 13px; margin-bottom: 12px; }
  .notification-actions { display: flex; gap: 8px; }
  .notification-btn { background: #0e1a26; color: var(--fg); border: 1px solid #1f2937; border-radius: 6px; padding: 6px 12px; font-size: 12px; cursor: pointer; }
  .notification-btn:hover { border-color: #374151; }
  .notification-close { position: absolute; top: 8px; right: 8px; background: none; border: none; color: var(--muted); cursor: pointer; font-size: 16px; }
  .notification-progress { margin-top: 8px; }
  .notification-progress-bar { width: 100%; height: 6px; background: #1f2937; border-radius: 3px; overflow: hidden; }
  .notification-progress-fill { height: 100%; background: linear-gradient(90deg, #6bb6ff, #6fe0b8); transition: width 0.3s ease; }
  .notification-progress-text { font-size: 11px; color: var(--muted); margin-top: 4px; }
  @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

  /* Announcements dropdown */
  .dropdown { position: relative; display: inline-block; }
  .dropdown-btn { background:#0e1a26; color:#e6eef7; border:1px solid #1f2937; border-radius:8px; padding:8px 12px; cursor:pointer; min-width: 180px; display:flex; align-items:center; justify-content:space-between; gap:8px }
  .dropdown-btn:hover { border-color:#374151 }
  .dropdown-badge { position:absolute; top:-4px; right:-4px; width:8px; height:8px; background:#ff6b6b; border-radius:50%; display:none }
  .dropdown-badge.show { display:block }
  .dropdown-panel { position:absolute; top: calc(100% + 6px); right: 0; background: var(--card); border:1px solid #1f2937; border-radius:10px; width: 360px; max-width: calc(100vw - 32px); box-shadow: 0 10px 24px rgba(0,0,0,.25); display:none; z-index:100; max-height: 360px; overflow:auto }
  .dropdown.open .dropdown-panel { display:block }
  .ann-item { padding:10px 12px; border-bottom:1px solid #172131 }
  .ann-item:last-child { border-bottom: 0 }
  .ann-title { font-weight:600; font-size:14px }
  .ann-meta { color: var(--muted); font-size:11px; margin-top:4px }
  .ann-type { text-transform:uppercase; font-size:10px; letter-spacing:.06em; padding:2px 6px; border:1px solid #263246; border-radius:999px; margin-left:6px }
  .ann-critical { border-left:3px solid #ff4757 }
  .ann-warning { border-left:3px solid #ffa502 }
  .ann-info { border-left:3px solid #3742fa }
  .ann-update { border-left:3px solid #2ed573 }
  .caret { transition: transform .15s ease }
  .dropdown.open .caret { transform: rotate(180deg) }

  
  @media (max-width: 768px) { .grid { gap:12px } }
</style>
<script>
async function probe(url, opts={}){
  const t0 = performance.now();
  try {
    const r = await fetch(url, { method:'GET', ...opts });
    const ms = Math.max(1, Math.round(performance.now()-t0));
    return { ok:r.ok, status:r.status, ms };
  } catch(e){
    const ms = Math.max(1, Math.round(performance.now()-t0));
    return { ok:false, status:0, ms };
  }
}
function setBadge(id, res){
  const b = document.getElementById(id);
  if(!b) return;
  const cls = res.ok ? 'badge ok' : 'badge err';
  b.className = cls;
  b.textContent = res.ok ? `healthy (${res.ms}ms)` : `down (${res.ms}ms)`;
}
async function refreshStatuses(){
  const [land, oweb, n8n, pih, ollama, minio, full, updates, pdfStatus] = await Promise.all([
    Promise.resolve({ok:true,ms:0}),
    probe('/status/oweb'),
    probe('/status/n8n'),
    probe('/status/pihole'),
    probe('/status/ollama'),
    probe('/status/minio'),
    fetch('/status/full').then(r=>r.ok?r.json():{}).catch(()=>({})),
    fetch('/status/updates').then(r=>r.ok?r.json():{}).catch(()=>({})),
    fetch('/status/pdf-processing').then(r=>r.ok?r.json():{}).catch(()=>({processing: false, error: null}))
  ]);
  
  // Check PDF processing status and show notification (handles all states)
  if(pdfStatus) {
    showPDFProcessingNotification(pdfStatus);
  }
  setBadge('badge-oweb', oweb);
  setBadge('badge-n8n', n8n);
  setBadge('badge-pihole', pih);
  setBadge('badge-ollama', ollama);
  setBadge('badge-minio', minio);
  // Update control buttons state
  setServiceButtons('oweb', oweb.ok);
  setServiceButtons('n8n', n8n.ok);
  setServiceButtons('pihole', pih.ok);
  setServiceButtons('ollama', ollama.ok);
  setServiceButtons('minio', minio.ok);
  
  // Update status indicators
  updateServiceStatus('oweb', oweb.ok, oweb.ms);
  updateServiceStatus('n8n', n8n.ok, n8n.ms);
  updateServiceStatus('pihole', pih.ok, pih.ms);
  updateServiceStatus('ollama', ollama.ok, ollama.ms);
  updateServiceStatus('minio', minio.ok, minio.ms);
  
  // Check for updates and show notification
  checkUpdateNotifications(updates);
  
  try{
    const setChip = (id, ok) => {
      const el = document.getElementById(id);
      if(!el) return;
      const dot = el.querySelector('.dot');
      if(dot){ dot.className = 'dot ' + (ok?'dot-ok':'dot-err'); }
      el.querySelector('.label').textContent = ok ? 'healthy' : 'down';
    };
    setChip('chip-ollama', !!full.ollama);
    setChip('chip-db', !!full.postgres);
    setChip('chip-redis', !!full.redis);
    setChip('chip-qdrant', !!full.qdrant);
    setChip('chip-tika', !!full.tika);
    setChip('chip-minio', !!full.minio);
    // Update KPIs
    const ext = (full.external_ip||full.ip||'');
    const vmip = full.vm_ip||'';
    const k1=document.getElementById('kpi-ext'); if(k1) k1.textContent = ext || '—';
    const k2=document.getElementById('kpi-vm'); if(k2) k2.textContent = vmip || '—';
    const kcpu=document.getElementById('kpi-cpu'); if(kcpu) kcpu.textContent = (full.cpu_cores||'—');
    const km=document.getElementById('kpi-mem'); if(km && full.memory_mb){ km.textContent = `${full.memory_mb.used}/${full.memory_mb.total} MB`; }
    const kd=document.getElementById('kpi-disk'); if(kd && full.disk_mb){ kd.textContent = `${full.disk_mb.used}/${full.disk_mb.total} MB`; }
    const tsEl=document.getElementById('last-updated'); if(tsEl){ const d=new Date(); tsEl.textContent=d.toLocaleTimeString(); }
  }catch(e){}
}
function setServiceButtons(id, running){
  const startBtn = document.getElementById(`btn-${id}-start`);
  const stopBtn = document.getElementById(`btn-${id}-stop`);
  if(!startBtn||!stopBtn) return;
  startBtn.disabled = running;
  stopBtn.disabled = !running;
}

function updateServiceStatus(id, isRunning, responseTime){
  const statusEl = document.getElementById(`status-${id}`);
  if(!statusEl) return;
  
  if(isRunning){
    statusEl.textContent = `Status: Running (${responseTime}ms)`;
    statusEl.style.color = '#6fe0b8';
  } else {
    statusEl.textContent = `Status: Stopped`;
    statusEl.style.color = '#ff9aa7';
  }
}

function setServiceLoading(id, loading, action){
  const startBtn = document.getElementById(`btn-${id}-start`);
  const stopBtn = document.getElementById(`btn-${id}-stop`);
  if(!startBtn||!stopBtn) return;
  
  if(loading){
    startBtn.disabled = true;
    stopBtn.disabled = true;
    startBtn.textContent = action === 'start' ? 'Starting...' : 'Start';
    stopBtn.textContent = action === 'stop' ? 'Stopping...' : 'Stop';
  } else {
    startBtn.disabled = false;
    stopBtn.disabled = false;
    startBtn.textContent = 'Start';
    stopBtn.textContent = 'Stop';
  }
}

function showNotification(message, type = 'info', progress = null, persistent = false){
  // Create notification element
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  if(persistent) notification.setAttribute('data-persistent', 'true');
  
  let progressHtml = '';
  if(progress !== null) {
    progressHtml = `
      <div class="notification-progress">
        <div class="notification-progress-bar">
          <div class="notification-progress-fill" style="width: ${progress}%"></div>
        </div>
        <div class="notification-progress-text">${progress}%</div>
      </div>
    `;
  }
  
  notification.innerHTML = `
    <div class="notification-header">
      <div class="notification-icon ${type}">${type === 'success' ? '✓' : type === 'error' ? '✗' : 'ℹ'}</div>
      <div class="notification-title">${type === 'success' ? 'Success' : type === 'error' ? 'Error' : 'Info'}</div>
    </div>
    <div class="notification-message">${message}</div>
    ${progressHtml}
  `;
  
  // Add to page
  document.body.appendChild(notification);
  
  // Show notification
  setTimeout(() => notification.classList.add('show'), 100);
  
  // Auto-hide after 3 seconds (unless persistent)
  if(!persistent) {
    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }
  
  return notification;
}

let pdfProcessingNotification = null;

function showPDFProcessingNotification(status) {
  // Handle completion or error states
  if(!status.processing) {
    if(status.progress === 100 && status.status === 'completed') {
      // Successfully completed
      const filename = status.current_file || 'PDF file';
      if(pdfProcessingNotification) {
        pdfProcessingNotification.classList.remove('show');
        setTimeout(() => {
          if(pdfProcessingNotification) {
            pdfProcessingNotification.remove();
            pdfProcessingNotification = null;
          }
          showNotification(`PDF processed successfully: ${filename}`, 'success');
        }, 500);
      } else {
        showNotification(`PDF processed successfully: ${filename}`, 'success');
      }
    } else if(status.error) {
      // Error occurred
      const errorMsg = status.error.length > 100 ? status.error.substring(0, 100) + '...' : status.error;
      if(pdfProcessingNotification) {
        pdfProcessingNotification.classList.remove('show');
        setTimeout(() => {
          if(pdfProcessingNotification) {
            pdfProcessingNotification.remove();
            pdfProcessingNotification = null;
          }
          showNotification(`PDF processing failed: ${errorMsg}`, 'error');
        }, 500);
      } else {
        showNotification(`PDF processing failed: ${errorMsg}`, 'error');
      }
    } else if(pdfProcessingNotification) {
      // Idle state - remove notification
      pdfProcessingNotification.classList.remove('show');
      setTimeout(() => {
        if(pdfProcessingNotification) {
          pdfProcessingNotification.remove();
          pdfProcessingNotification = null;
        }
      }, 300);
    }
    return;
  }
  
  // Processing is active
  const filename = status.current_file || 'Unknown file';
  const progress = Math.max(0, Math.min(100, status.progress || 0)); // Clamp to 0-100
  const statusText = status.status || 'processing';
  
  if(!pdfProcessingNotification) {
    // Create new notification
    pdfProcessingNotification = showNotification(
      `Processing PDF: ${filename}`,
      'info',
      progress,
      true // persistent
    );
  } else {
    // Update existing notification
    const messageEl = pdfProcessingNotification.querySelector('.notification-message');
    const progressBar = pdfProcessingNotification.querySelector('.notification-progress-fill');
    const progressText = pdfProcessingNotification.querySelector('.notification-progress-text');
    
    if(messageEl) messageEl.textContent = `Processing PDF: ${filename}`;
    if(progressBar) progressBar.style.width = `${progress}%`;
    if(progressText) {
      const displayText = statusText.length > 40 ? statusText.substring(0, 40) + '...' : statusText;
      progressText.textContent = `${progress}% - ${displayText}`;
    }
  }
}

async function controlService(service, action){
  const serviceId = service.replace('open-webui', 'oweb').replace('ai_', '');
  setServiceLoading(serviceId, true, action);
  
  try{
    const token = localStorage.getItem('control-token')||'';
    const r = await fetch(`/control/${service}/${action}`, {
      method: 'POST',
      headers: { 'X-Control-Token': token }
    });
    
    if(!r.ok){
      const t = await r.text();
      showNotification(`Failed to ${action} ${service}: ${t}`, 'error');
      setServiceLoading(serviceId, false);
      return;
    }
    
    const result = await r.json();
    if(result.ok){
      showNotification(`${service} ${action} command sent successfully`, 'success');
      
      // Poll for status change with timeout
      let attempts = 0;
      const maxAttempts = 20; // 20 seconds timeout
      const pollStatus = async () => {
        attempts++;
        try {
          const statusResponse = await fetch(`/status/${serviceId}`);
          const isRunning = statusResponse.ok;
          
          if((action === 'start' && isRunning) || (action === 'stop' && !isRunning)){
            showNotification(`${service} ${action} completed successfully`, 'success');
            setServiceLoading(serviceId, false);
            refreshStatuses();
            return;
          }
          
          if(attempts >= maxAttempts){
            showNotification(`${service} ${action} taking longer than expected. Check status manually.`, 'info');
            setServiceLoading(serviceId, false);
            refreshStatuses();
            return;
          }
          
          setTimeout(pollStatus, 1000); // Poll every second
        } catch(e) {
          showNotification(`Error checking ${service} status: ${e.message}`, 'error');
          setServiceLoading(serviceId, false);
          refreshStatuses();
        }
      };
      
      // Start polling after 2 seconds
      setTimeout(pollStatus, 2000);
    } else {
      showNotification(`Failed to ${action} ${service}: ${result.error || 'Unknown error'}`, 'error');
      setServiceLoading(serviceId, false);
    }
  }catch(e){
    showNotification(`Error: ${e.message}`, 'error');
    setServiceLoading(serviceId, false);
  }
}
function startAutoRefresh(){
  refreshStatuses();
  setInterval(refreshStatuses, 15000);
  // Poll PDF processing status more frequently (every 2 seconds) when processing
  let lastProcessingState = false;
  setInterval(async () => {
    try {
      const pdfStatus = await fetch('/status/pdf-processing').then(r=>r.ok?r.json():{}).catch(()=>({processing: false}));
      if(pdfStatus) {
        const isProcessing = pdfStatus.processing === true;
        // Only update if state changed or actively processing
        if(isProcessing || isProcessing !== lastProcessingState) {
          showPDFProcessingNotification(pdfStatus);
          lastProcessingState = isProcessing;
        }
      }
    } catch(e) {
      // Silently fail - don't spam console
    }
  }, 2000);
}

// Update notification system
function checkUpdateNotifications(updates) {
  if (!updates || !updates.updates_available) return;
  
  // Check if notification was already shown today
  const lastShown = localStorage.getItem('tu-vm-update-notification');
  const today = new Date().toDateString();
  
  if (lastShown === today) return;
  
  showUpdateNotification(updates);
  localStorage.setItem('tu-vm-update-notification', today);
}

function showUpdateNotification(updates) {
  const notification = document.getElementById('update-notification');
  if (!notification) return;
  
  const title = notification.querySelector('.notification-title');
  const message = notification.querySelector('.notification-message');
  const lastCheck = notification.querySelector('.notification-last-check');
  
  title.textContent = 'Updates Available';
  message.textContent = updates.message || 'System updates are available. Run "sudo ./tu-vm.sh update" to apply them.';
  lastCheck.textContent = `Last checked: ${new Date(updates.last_check).toLocaleString()}`;
  
  notification.classList.add('show');
}

function hideNotification() {
  const notification = document.getElementById('update-notification');
  if (notification) {
    notification.classList.remove('show');
  }
}

function runUpdate() {
  // This would need to be implemented as a separate endpoint or action
  alert('To run updates, please SSH into the VM and run: sudo ./tu-vm.sh update');
}

async function allowlistAutoEnroll(){
  // helper_index can take a bit to come up (it installs deps on boot).
  // Retry for a short window so first-visit bootstrap is reliable.
  const deadline = Date.now() + 30000;
  let delay = 500;
  while(Date.now() < deadline){
    try{
      const r = await fetch('/whitelist/auto', { method:'GET', cache:'no-store' });
      if(r.ok) return;
    }catch(e){}
    await new Promise(res=>setTimeout(res, delay));
    delay = Math.min(3000, Math.floor(delay * 1.6));
  }
}

async function fetchAllowlist(){
  const token = localStorage.getItem('control-token')||'';
  const r = await fetch('/whitelist', { headers: { 'X-Control-Token': token }});
  if(!r.ok) throw new Error(await r.text());
  return await r.json();
}

function renderAllowlist(ips){
  const list = document.getElementById('allowlist-list');
  if(!list) return;
  list.innerHTML = '';
  (ips||[]).forEach(ip=>{
    const row = document.createElement('div');
    row.className = 'row-inline';
    row.style = 'justify-content:space-between';
    row.innerHTML = `
      <div class="mono">${ip}</div>
      <button class="btn btn-sm" data-ip="${ip}">Remove</button>
    `;
    row.querySelector('button').addEventListener('click', async (ev)=>{
      const ip = ev.target.getAttribute('data-ip');
      await allowlistRemove(ip);
    });
    list.appendChild(row);
  });
  if((ips||[]).length===0){
    const empty = document.createElement('div');
    empty.className = 'muted';
    empty.textContent = 'No IPs allowed yet. The first visitor can be auto-enrolled.';
    list.appendChild(empty);
  }
}

async function refreshAllowlist(){
  try{
    const data = await fetchAllowlist();
    renderAllowlist(data.ips||[]);
  }catch(e){
    // If blocked, try bootstrap once then re-try list.
    await allowlistAutoEnroll();
    try{
      const data = await fetchAllowlist();
      renderAllowlist(data.ips||[]);
      return;
    }catch(e2){}
    // If still unauthorized/blocked, show minimal hint
    const list = document.getElementById('allowlist-list');
    if(list){
      list.innerHTML = `<div class="muted">Allowlist unavailable (${e.message}). Check CONTROL_TOKEN and IP allowlist.</div>`;
    }
  }
}

async function allowlistAdd(ip){
  const token = localStorage.getItem('control-token')||'';
  const r = await fetch('/whitelist/add', {
    method:'POST',
    headers: { 'Content-Type':'application/json', 'X-Control-Token': token },
    body: JSON.stringify({ ip })
  });
  if(!r.ok) throw new Error(await r.text());
  await refreshAllowlist();
}

async function allowlistRemove(ip){
  const token = localStorage.getItem('control-token')||'';
  const r = await fetch('/whitelist/remove', {
    method:'POST',
    headers: { 'Content-Type':'application/json', 'X-Control-Token': token },
    body: JSON.stringify({ ip })
  });
  if(!r.ok) throw new Error(await r.text());
  await refreshAllowlist();
}

window.addEventListener('DOMContentLoaded',()=>{
  // Control token is required for service management; do not overwrite an existing token.
  // If you haven't set one yet, set CONTROL_TOKEN in .env and then paste it into localStorage once.
  if(localStorage.getItem('control-token') === null){
    localStorage.setItem('control-token', '');
  }
  // Populate token input (if present)
  try{
    const tok = localStorage.getItem('control-token')||'';
    const el = document.getElementById('control-token-input');
    if(el) el.value = tok;
  }catch(e){}
  // Bootstrap: record first visitor IP (only when allowlist is empty)
  allowlistAutoEnroll();
  refreshAllowlist();
  startAutoRefresh();
  // Load announcements on page load
  setTimeout(() => {
    loadAnnouncements();
  }, 2000); // Show after 2 seconds
});
async function copyText(t){ try{ await navigator.clipboard.writeText(t); }catch(e){} }

// Announcement system (dropdown only)
let announcements = [];

function refreshAnnouncements() {
  loadAnnouncements();
}

async function loadAnnouncements() {
  try {
    const response = await fetch('/status/announcements');
    const data = await response.json();
    announcements = data.announcements || [];
    updateAnnouncementDisplay();
  } catch (error) {
    console.error('Failed to load announcements:', error);
    announcements = [{
      title: "System Status",
      message: "Welcome to TechUties VM! Your AI platform is running smoothly.",
      type: "info",
      timestamp: new Date().toISOString()
    }];
    updateAnnouncementDisplay();
  }
}

function updateAnnouncementDisplay() {
  // Populate dropdown list
  renderAnnouncementsDropdown();
  // Show badge if there are announcements
  const badge = document.querySelector('.dropdown-badge');
  if (badge) {
    badge.classList.toggle('show', announcements.length > 0);
  }
}

function getTimeAgo(timestamp) {
  const now = new Date();
  const time = new Date(timestamp);
  const diffMs = now - time;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  
  if (diffMins < 1) return 'just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  return `${diffDays}d ago`;
}

// Dropdown logic
function toggleAnnouncementsDropdown(ev){
  const dd = document.getElementById('announcements-dropdown');
  if(!dd) return;
  const isOpen = dd.classList.contains('open');
  document.querySelectorAll('.dropdown.open').forEach(el=>el.classList.remove('open'));
  if(!isOpen){ dd.classList.add('open'); }
}
function closeAnnouncementsDropdown(){
  const dd = document.getElementById('announcements-dropdown');
  if(dd) dd.classList.remove('open');
}
function onDropdownKey(e){
  if(e.key === 'Escape'){ closeAnnouncementsDropdown(); }
}
document.addEventListener('click', (e)=>{
  const dd = document.getElementById('announcements-dropdown');
  if(!dd) return;
  if(!dd.contains(e.target)) closeAnnouncementsDropdown();
});
function renderAnnouncementsDropdown(){
  const list = document.getElementById('announcements-list');
  const count = document.getElementById('announcements-count');
  if(!list) return;
  list.innerHTML = '';
  (announcements||[]).forEach(a=>{
    const li = document.createElement('div');
    li.className = `ann-item ann-${a.type || 'info'}`;
    const when = getTimeAgo(a.timestamp);
    const type = (a.type||'info').toUpperCase();
    li.innerHTML = `
      <div class="ann-title">${a.title}<span class="ann-type">${type}</span></div>
      <div class="ann-meta">${when}</div>
      <div class="ann-msg" style="margin-top:6px">${a.message}</div>
    `;
    list.appendChild(li);
  });
  if(count){ count.textContent = (announcements||[]).length; }
}
</script>
</head>
<body>
  

  <div class="wrap">
    <div class="hero">
      <div class="hero-head">
        <div>
          <h1>TechUties VM</h1>
          <p class="lead">Private AI & Automation stack on Ubuntu Server. Secure, local‑first, and vendor‑neutral.</p>
        </div>
        <div id="announcements-dropdown" class="dropdown" onkeydown="onDropdownKey(event)" style="align-self:flex-start; position:relative;">
          <button class="dropdown-btn" aria-haspopup="true" aria-expanded="false" onclick="toggleAnnouncementsDropdown(event)" title="Show all announcements">
            <span>Announcements</span>
            <span class="muted" style="font-size:12px">(<span id="announcements-count">0</span>)</span>
            <span class="caret">▾</span>
          </button>
          <div class="dropdown-badge"></div>
          <div class="dropdown-panel" role="menu" aria-label="Announcements">
            <div id="announcements-list" aria-live="polite"></div>
          </div>
        </div>
      </div>
      <div class="section-title">Host Access</div>
      <div class="grid">
        <div class="card">
          <span id="badge-oweb" class="badge warn">checking…</span>
          <a href="https://oweb.tu.local/"><div class="name">Open WebUI</div><div class="url">oweb.tu.local</div></a>
          <div class="row" style="margin-top:8px">
            <button id="btn-oweb-start" class="btn btn-sm" onclick="controlService('open-webui','start')">Start</button>
            <button id="btn-oweb-stop" class="btn btn-sm" onclick="controlService('open-webui','stop')">Stop</button>
          </div>
        </div>
        <div class="card">
          <span id="badge-n8n" class="badge warn">checking…</span>
          <a href="https://n8n.tu.local/"><div class="name">n8n</div><div class="url">n8n.tu.local</div></a>
          <div class="row" style="margin-top:8px">
            <button id="btn-n8n-start" class="btn btn-sm" onclick="controlService('n8n','start')">Start</button>
            <button id="btn-n8n-stop" class="btn btn-sm" onclick="controlService('n8n','stop')">Stop</button>
          </div>
          <div id="status-n8n" class="status" style="margin-top:6px; font-size:12px; color:var(--muted);">Status: Checking...</div>
        </div>
        <div class="card">
          <span id="badge-pihole" class="badge warn">checking…</span>
          <a href="https://pihole.tu.local/admin"><div class="name">Pi‑hole Admin</div><div class="url">pihole.tu.local/admin</div></a>
          <div class="row" style="margin-top:8px">
            <button id="btn-pihole-start" class="btn btn-sm" onclick="controlService('pihole','start')">Start</button>
            <button id="btn-pihole-stop" class="btn btn-sm" onclick="controlService('pihole','stop')">Stop</button>
          </div>
        </div>
        <div class="card">
          <span id="badge-ollama" class="badge warn">checking…</span>
          <a href="https://ollama.tu.local/"><div class="name">Ollama AI</div><div class="url">ollama.tu.local</div></a>
          <div class="row" style="margin-top:8px">
            <button id="btn-ollama-start" class="btn btn-sm" onclick="controlService('ollama','start')">Start</button>
            <button id="btn-ollama-stop" class="btn btn-sm" onclick="controlService('ollama','stop')">Stop</button>
          </div>
          <div id="status-ollama" class="status" style="margin-top:6px; font-size:12px; color:var(--muted);">Status: Checking...</div>
        </div>
        <div class="card">
          <span id="badge-minio" class="badge warn">checking…</span>
          <a href="https://minio.tu.local/"><div class="name">MinIO Console</div><div class="url">minio.tu.local</div></a>
          <div class="row" style="margin-top:8px">
            <button id="btn-minio-start" class="btn btn-sm" onclick="controlService('minio','start')">Start</button>
            <button id="btn-minio-stop" class="btn btn-sm" onclick="controlService('minio','stop')">Stop</button>
          </div>
          <div id="status-minio" class="status" style="margin-top:6px; font-size:12px; color:var(--muted);">Status: Checking...</div>
        </div>
      </div>
      <div class="section-title">VM Access</div>
      <div class="chips">
        <div id="chip-ollama" class="chip"><span class="dot dot-err"></span><code>ai_ollama:11434</code> · <span class="label">…</span></div>
        <div id="chip-db" class="chip"><span class="dot dot-err"></span><code>ai_postgres:5432</code> · <span class="label">…</span></div>
        <div id="chip-redis" class="chip"><span class="dot dot-err"></span><code>ai_redis:6379</code> · <span class="label">…</span></div>
        <div id="chip-qdrant" class="chip"><span class="dot dot-err"></span><code>ai_qdrant:6333</code> · <span class="label">…</span></div>
        <div id="chip-tika" class="chip"><span class="dot dot-err"></span><code>ai_tika:9998</code> · <span class="label">…</span></div>
        <div id="chip-minio" class="chip"><span class="dot dot-err"></span><code>ai_minio:9000</code> · <span class="label">…</span></div>
      </div>
      <div class="status"><button class="btn" onclick="refreshStatuses()">Refresh</button> <span class="muted">Last updated: <span id="last-updated">–</span></span></div>
      <div class="kpis" aria-label="Hardware exposure">
        <div class="kpi"><div class="muted">External IP</div><div id="kpi-ext" class="name">—</div></div>
        <div class="kpi"><div class="muted">VM IP</div><div id="kpi-vm" class="name">—</div></div>
        <div class="kpi"><div class="muted">CPU Cores</div><div id="kpi-cpu" class="name">—</div></div>
        <div class="kpi"><div class="muted">Memory</div><div id="kpi-mem" class="name">—</div></div>
        <div class="kpi"><div class="muted">Disk</div><div id="kpi-disk" class="name">—</div></div>
      </div>
    </div>

    <div class="hero" style="margin-top:16px">
      <div class="hero-head">
        <div>
          <h1 style="font-size:18px;margin:0">Access Control</h1>
          <p class="lead">Only IPs on the allowlist can use <code>/control/*</code> and manage the allowlist.</p>
        </div>
      </div>
      <div class="section-title">Control Token</div>
      <div class="row" style="margin-top:8px">
        <input id="control-token-input" type="text" placeholder="Paste CONTROL_TOKEN here (required for control + allowlist changes)" />
        <button class="btn" onclick="(()=>{ const v=document.getElementById('control-token-input').value.trim(); localStorage.setItem('control-token', v); showNotification('Token saved in browser','success'); refreshAllowlist(); })()">Save</button>
      </div>
      <div class="section-title">IP Allowlist</div>
      <div class="row" style="margin-top:8px">
        <input id="allowlist-ip" type="text" placeholder="Add IP (e.g. 192.168.1.25 or 2001:db8::1)" />
        <button class="btn" onclick="(async()=>{ const ip=document.getElementById('allowlist-ip').value.trim(); if(!ip) return; try{ await allowlistAdd(ip); document.getElementById('allowlist-ip').value=''; }catch(e){ showNotification(e.message,'error'); } })()">Add</button>
        <button class="btn" onclick="refreshAllowlist()">Refresh</button>
      </div>
      <div id="allowlist-list" class="kpi" style="margin-top:10px"></div>
      <div class="muted" style="margin-top:10px">
        Tip: first visit from a client will auto-enroll that client IP once (via <code>/whitelist/auto</code>).
      </div>
    </div>

    

    <div class="thanks">
      <h3>Contributors</h3>
      <p>Thanks to <a href="https://www.linkedin.com/in/sebastianbecke/" target="_blank" rel="noreferrer noopener">Sebastian Becker</a> for major contributions.</p>
    </div>



    <div class="footer">
      <div class="links">Resources: 
        <a href="https://www.techuties.com" target="_blank" rel="noreferrer noopener">TechUties</a> · 
        <a href="https://github.com/techuties/tu-vm" target="_blank" rel="noreferrer noopener">GitHub Repo</a>
      </div>
      <p>Thank you for using TechUties VM. <span role="img" aria-label="sparkles">✨</span></p>
    </div>
  </div>
</body>
</html>
